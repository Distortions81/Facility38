#!/bin/bash

# exit when any command fails
set -e

#Make date string
curTime=`date -u '+%Y-%m-%d-%H-%M-%S'`

#Build with time string
go build -pgo=auto -ldflags="-X main.buildTime=$curTime"
#Get reply with full version string
versionString=`./Facility38 --version`

mv BUILD/builds/*.zip BUILD/builds/old-builds || true

#Push new version to auth server
../BuildUtilF38/BuildUtilF38 -build="$versionString" -path="../Facility38/data/txt/" -pass="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"

ssh -p 5313 dist@facility38.go-game.net "mv ~/F38Auth/www/dl/*.zip ~/F38Auth/www/dl/old-builds/" || true

#Build all with new key
bash BUILD/winbuild.sh $curTime
bash BUILD/linuxbuild.sh $curTime
bash BUILD/wasm.sh $curTime

#Make code backup for this version for debug ref
7z a -t7z BUILD/builds/code-ref/$versionString.7z *.go */*.go

#Let user know we are done.
echo "Build of '$versionString' complete, pushing build."

